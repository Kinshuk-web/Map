<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Urban Renew Map â€” Realtime Pins</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>

<style>
  html, body { height:100%; width:100%; margin:0; padding:0; }
  #map { position:absolute; top:0; left:0; height:100vh; width:100vw; z-index:0; }
  .modal-scale { transform:scale(.98); opacity:0; transition:all 150ms ease; }
  .modal-open { transform:scale(1); opacity:1; }
</style>
</head>

<body class="bg-gray-100 overflow-hidden">

<!-- Floating Controls -->
<div class="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] bg-white/95 px-4 py-3 rounded-xl shadow-xl flex gap-3 items-center flex-wrap justify-center">
  <div id="editor-status" class="hidden bg-gray-100 px-3 py-2 rounded-lg shadow-sm text-gray-800 text-sm">
    Signed in: <span id="user-email">â€”</span>
  </div>
  
  <!-- Search Box -->
  <div class="flex gap-1 bg-gray-100 rounded-lg px-2 py-1">
    <input id="search-input" placeholder="Search location..." class="bg-transparent border-0 px-2 py-1 text-sm focus:outline-none placeholder-gray-500" />
    <button id="search-btn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">ğŸ”</button>
  </div>
  
  <button id="locate-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 flex items-center gap-1 text-sm">ğŸ“ Locate Me</button>
  <button id="signin-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-1 text-sm">ğŸ‘¤ Sign in with Google</button>
  <button id="signout-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg shadow hover:bg-gray-300 flex items-center gap-1 text-sm hidden">ğŸšª Sign Out</button>
</div>

<!-- Map Container -->
<div id="map"></div>

<!-- Add Pin Modal -->
<div id="pin-modal" class="fixed inset-0 hidden z-[2000] bg-black bg-opacity-40 flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-scale shadow-2xl">
    <h3 class="text-xl font-bold mb-2 text-gray-800">Add Pin</h3>
    <p id="pin-coords" class="text-sm text-gray-600 mb-4 bg-gray-50 p-2 rounded"></p>
    <form id="pin-form" class="space-y-3">
      <input id="pin-title" required placeholder="Title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <textarea id="pin-desc" rows="3" placeholder="Description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" id="cancel-pin" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Alert Modal -->
<div id="alert-modal" class="fixed inset-0 hidden z-[3000] bg-black bg-opacity-40 flex items-center justify-center p-4">
  <div class="bg-white p-6 rounded-xl modal-scale max-w-sm w-full text-center shadow-2xl">
    <p id="alert-text" class="text-gray-800 mb-4"></p>
    <button id="alert-ok" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">OK</button>
  </div>
</div>

<script>
// âœ… Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBuQI813zZeJj4RSlU2_fsBb20lWTCqa7o",
  authDomain: "urban-renew-map.firebaseapp.com",
  databaseURL: "https://urban-renew-map-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "urban-renew-map",
  storageBucket: "urban-renew-map.firebasestorage.app",
  messagingSenderId: "138295290989",
  appId: "1:138295290989:web:3ae9ce333ebc4a1a6aa364"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

const signinBtn = document.getElementById('signin-btn');
const signoutBtn = document.getElementById('signout-btn');
const editorStatus = document.getElementById('editor-status');
const userEmailSpan = document.getElementById('user-email');
const locateBtn = document.getElementById('locate-btn');
const alertModal = document.getElementById('alert-modal');
const alertText = document.getElementById('alert-text');
const alertOk = document.getElementById('alert-ok');

// Search functionality
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
searchBtn.onclick = async () => {
  const query = searchInput.value.trim();
  if (!query) return;
  try {
    const res = await fetch(https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&addressdetails=1);
    const data = await res.json();
    if (data.length > 0) {
      const { lat, lon } = data[0];
      map.flyTo([parseFloat(lat), parseFloat(lon)], 14);
      searchInput.value = ''; // Clear input after successful search
    } else {
      showAlert('Location not found');
    }
  } catch (err) {
    showAlert('Search failed. Please try again.');
  }
};
// Allow Enter key to trigger search
searchInput.onkeypress = (e) => {
  if (e.key === 'Enter') {
    searchBtn.click();
  }
};

function showAlert(msg) {
  alertText.textContent = msg;
  alertModal.classList.remove('hidden');
  setTimeout(() => alertModal.querySelector('.modal-scale').classList.add('modal-open'), 10);
}
alertOk.onclick = () => alertModal.classList.add('hidden');

// Initialize map with bounds
const map = L.map('map', { 
  minZoom: 2, 
  maxBounds: [[-85,-180],[85,180]]
}).setView([20,0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

// Realtime pins
const pinsRef = db.ref('pins');
const markers = {};

function escapeHTML(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// Load + sync pins
function renderPin(key, data) {
  const m = L.marker([data.lat, data.lng]).addTo(map);
  
  // Zoom on pin click
  m.on('click', () => {
    map.flyTo([data.lat, data.lng], 15, { duration: 0.8 });
  });

  let popupHTML = <b>${escapeHTML(data.title)}</b><br>${escapeHTML(data.description)}<br><small>${escapeHTML(data.userEmail)}</small>;
  const u = auth.currentUser;
  if (u && u.uid === data.uid) {
    popupHTML += <br><button class="delete-pin-btn bg-red-600 text-white px-2 py-1 rounded mt-1 text-xs" data-id="${key}">ğŸ—‘ Delete</button>;
  }
  m.bindPopup(popupHTML);
  markers[key] = m;
}

pinsRef.on('child_added', snap => {
  const d = snap.val(), k = snap.key;
  if (markers[k]) return;
  renderPin(k, d);
});

pinsRef.on('child_removed', snap => {
  const k = snap.key;
  if (markers[k]) { map.removeLayer(markers[k]); delete markers[k]; }
});

// Delegate delete button click inside popups
document.addEventListener('click', e => {
  if (e.target.classList.contains('delete-pin-btn')) {
    const id = e.target.dataset.id;
    const user = auth.currentUser;
    if (!user) return showAlert("Sign in first");
    pinsRef.child(id).get().then(snap => {
      if (!snap.exists()) return showAlert("Pin no longer exists");
      const data = snap.val();
      if (data.uid !== user.uid) return showAlert("You can only delete your own pins");
      if (confirm("Delete this pin?")) {
        pinsRef.child(id).remove();
        showAlert("Pin deleted");
      }
    });
  }
});

// Add Pin Flow
const pinModal = document.getElementById('pin-modal');
const pinCoords = document.getElementById('pin-coords');
const pinForm = document.getElementById('pin-form');
const pinTitle = document.getElementById('pin-title');
const pinDesc = document.getElementById('pin-desc');
const cancelPin = document.getElementById('cancel-pin');
let pendingLatLng = null;

map.on('click', e => {
  const u = auth.currentUser;
  if (!u || u.isAnonymous) { showAlert('Sign in first'); return; }
  pendingLatLng = e.latlng;
  pinCoords.textContent = Lat: ${e.latlng.lat.toFixed(4)}, Lng: ${e.latlng.lng.toFixed(4)};
  pinModal.classList.remove('hidden');
  setTimeout(() => pinModal.querySelector('.modal-scale').classList.add('modal-open'), 10);
});
cancelPin.onclick = () => pinModal.classList.add('hidden');

// Rate-limited pin submission
pinForm.onsubmit = async ev => {
  ev.preventDefault();
  const u = auth.currentUser;
  if (!u || u.isAnonymous) {
    showAlert('Sign in first');
    return;
  }

  const snapshot = await pinsRef.orderByChild('uid').equalTo(u.uid).once('value');
  const pins = snapshot.val();
  const now = Date.now();
  const pinArray = pins ? Object.values(pins) : [];

  // Filter pins added in the last 24 hours
  const recentPins = pinArray.filter(p => now - p.timestamp < 24 * 60 * 60 * 1000);

  if (recentPins.length >= 5) {
    showAlert('Youâ€™ve reached your 5-pin limit. Please wait 24 hours before adding more.');
    return;
  }

  await pinsRef.push({
    lat: pendingLatLng.lat,
    lng: pendingLatLng.lng,
    title: pinTitle.value,
    description: pinDesc.value,
    uid: u.uid,
    userEmail: u.email,
    timestamp: now
  });

  // Clear form
  pinTitle.value = '';
  pinDesc.value = '';
  pinModal.classList.add('hidden');
  showAlert('Pin added successfully!');
};

// Locate Me
locateBtn.onclick = () => {
  if (!navigator.geolocation) return showAlert('Geolocation not supported');
  navigator.geolocation.getCurrentPosition(p => {
    map.flyTo([p.coords.latitude, p.coords.longitude], 14);
  }, () => showAlert('Location access denied'), { enableHighAccuracy: true });
};

// Auth handling
const provider = new firebase.auth.GoogleAuthProvider();
signinBtn.onclick = () => auth.signInWithPopup(provider).catch(err => showAlert(err.message));
signoutBtn.onclick = () => auth.signOut();
auth.onAuthStateChanged(u => {
  if (u && !u.isAnonymous) {
    signinBtn.classList.add('hidden');
    signoutBtn.classList.remove('hidden');
    editorStatus.classList.remove('hidden');
    userEmailSpan.textContent = u.email;
  } else {
    signinBtn.classList.remove('hidden');
    signoutBtn.classList.add('hidden');
    editorStatus.classList.add('hidden');
    userEmailSpan.textContent = '';
  }
});
auth.signInAnonymously().catch(console.error);
</script>

</body>
</html>
